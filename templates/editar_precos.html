{% extends "base.html" %}

{% block title %}Editar Preços - Grupo {{ codigo_base }}{% endblock %}

{% block content %}
<div class="container py-4">
    <h3 class="mb-4">Editar Preços - Grupo {{ codigo_base }} <span class="text-muted" style="font-size:1.1em;">{{ descricao_produto }}</span></h3>
    <form method="POST">
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="percentual" class="form-label">Ajuste Percentual (%)</label>
                <input type="number" step="0.01" class="form-control" id="percentual" placeholder="Ex: 5 para +5%" autocomplete="off">
            </div>
            <div class="col-md-4 d-flex align-items-end gap-2">
                <button type="button" class="btn btn-info w-50" id="btn-previsualizar">Gerar Pré-visualização</button>
                <button type="button" class="btn btn-warning w-50" id="btn-limpar">Limpar</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered align-middle bg-white" id="tabela-precos">
                <thead class="table-light">
                    <tr>
                        <th>Cor</th>
                        <th>Código</th>
                        {% set nomes_tabelas = [
                            'Varejo 5k', 'Varejo 25k', 'Varejo 50k', 'Atacado', 'Gold', 'Amazon/Mac', 'Acre/Rond.'
                        ] %}
                        {% for nome in nomes_tabelas %}
                            <th>{{ nome }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for variante in variantes %}
                    <tr>
                        <td><span class="badge bg-secondary">{{ variante.Desc_Cor }}</span></td>
                        <td>{{ variante.codigo_produto }}</td>
                        <td><input type="text" class="form-control text-center fw-bold preco-input" name="TABELA_VAREJO_5_000_{{ variante.codigo_produto }}" value="{{ variante['TABELA_VAREJO_5_000']|default(0)|format_price }}" autocomplete="off"></td>
                        <td><input type="text" class="form-control text-center fw-bold preco-input" name="TABELA_VAREJO_25_000_{{ variante.codigo_produto }}" value="{{ variante['TABELA_VAREJO_25_000']|default(0)|format_price }}" autocomplete="off"></td>
                        <td><input type="text" class="form-control text-center fw-bold preco-input" name="TABELA_VAREJO_50_000_{{ variante.codigo_produto }}" value="{{ variante['TABELA_VAREJO_50_000']|default(0)|format_price }}" autocomplete="off"></td>
                        <td><input type="text" class="form-control text-center fw-bold preco-input" name="TABELA_ATACADO_{{ variante.codigo_produto }}" value="{{ variante['TABELA_ATACADO']|default(0)|format_price }}" autocomplete="off"></td>
                        <td><input type="text" class="form-control text-center fw-bold preco-input" name="TABELA_GOLD_PARCEIRO_{{ variante.codigo_produto }}" value="{{ variante['TABELA_GOLD_PARCEIRO']|default(0)|format_price }}" autocomplete="off"></td>
                        <td><input type="text" class="form-control text-center fw-bold preco-input" name="TABELA_ATACADO_AMAZONIA_E_MACAPA_{{ variante.codigo_produto }}" value="{{ variante['TABELA_ATACADO_AMAZONIA_E_MACAPA']|default(0)|format_price }}" autocomplete="off"></td>
                        <td><input type="text" class="form-control text-center fw-bold preco-input" name="TABELA_ACRE_E_RONDONIA_{{ variante.codigo_produto }}" value="{{ variante['TABELA_ACRE_E_RONDONIA']|default(0)|format_price }}" autocomplete="off"></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mt-4 text-center">
            <button type="submit" class="btn btn-success btn-lg">Salvar</button>
            <a href="{{ url_for('galeria') }}" class="btn btn-secondary btn-lg ms-2">Cancelar</a>
        </div>
    </form>
</div>

<script>
// Salvar os valores originais ao carregar a página
const precosOriginais = [];
document.querySelectorAll('.preco-input').forEach(function(input) {
    precosOriginais.push(input.value);
});

document.getElementById('btn-previsualizar').addEventListener('click', function(e) {
    e.preventDefault();
    const percentual = parseFloat(document.getElementById('percentual').value.replace(',', '.'));
    if (isNaN(percentual)) {
        alert('Digite um valor percentual válido!');
        return;
    }
    document.querySelectorAll('.preco-input').forEach(function(input) {
        let valor = input.value.replace('R$','').replace(/\./g, '').replace(',', '.').trim();
        valor = parseFloat(valor);
        if (!isNaN(valor)) {
            let novo = valor * (1 + percentual/100);
            // Formatar para BR
            novo = novo.toFixed(2).replace('.', ',');
            input.value = novo;
        }
    });
});

document.getElementById('btn-limpar').addEventListener('click', function(e) {
    e.preventDefault();
    document.querySelectorAll('.preco-input').forEach(function(input, idx) {
        input.value = precosOriginais[idx];
    });
    document.getElementById('percentual').value = '';
});
</script>
{% endblock %} 